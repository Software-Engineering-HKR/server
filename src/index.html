<!DOCTYPE html>
<html>
  <head>
    <meta name="viewport" content="width=device-width,initial-scale=1.0">
    <title>Socket.IO chat</title>
  </head>
  <body>
    <input id="messageBox" type="text">
    <button type="button" onclick="message()">Post</button>
  
    <form onsubmit="login(event)" method="post">
      <div class="container">
        <label for="username"><b>Username</b></label>
        <input type="text" placeholder="Enter Username" name="username" required>
  
        <label for="password"><b>Password</b></label>
        <input type="password" placeholder="Enter Password" name="password" required>
  
        <button type="submit">Login</button>
      </div>
    </form>

     
    <form onsubmit="register(event)" method="post">
      <div class="container">
        <label for="username"><b>Username</b></label>
        <input type="text" placeholder="Enter Username" name="username" required>
  
        <label for="password"><b>Password</b></label>
        <input type="password" placeholder="Enter Password" name="password" required>
  
        <button type="submit">register</button>
      </div>
    </form>
  
    <div id="deviceStatusContainer"></div>
    <script src="/socket.io/socket.io.js"></script>
    <script>
      var token = null;
      async function login(event) {
        event.preventDefault(); // Prevent the default form submission behavior
  
        // Access the form element
        var form = event.target;
  
        // Access form inputs by their 'name' attribute and print their values
        var username = form.elements["username"].value;
        var password = form.elements["password"].value;

        const url = `http://localhost:3000/auth/login`;
        const user = {username, password}

        try {
          const response = await fetch(url, {
              method: 'POST',
              headers: {
                  'Content-Type': 'application/json',
              },
              body: JSON.stringify(user),
          });
          if (!response.ok) {
              throw new Error(`HTTP error! Status: ${response.status}`);
          }
          const data = await response.json();
          token = data.token
          console.log(data)
        } catch (err) {
            console.error('Fetch error:', err);
        }
      }

      async function register(event) {
        event.preventDefault(); // Prevent the default form submission behavior
  
        // Access the form element
        var form = event.target;
  
        // Access form inputs by their 'name' attribute and print their values
        var username = form.elements["username"].value;
        var password = form.elements["password"].value;

        const url = `http://localhost:3000/auth/register`;
        const user = {username, password}


        try {
          const response = await fetch(url, {
              method: 'POST',
              headers: {
                  'Content-Type': 'application/json',
              },
              body: JSON.stringify(user),
          });
          if (!response.ok) {
              throw new Error(`HTTP error! Status: ${response.status}`);
          }
          const data = await response.json();
          console.log(data)
        } catch (err) {
            console.error('Fetch error:', err);
        }

      }


      async function message() {
        const url = `http://localhost:3000/api/LCD`;
        const dataToSend = { message: document.getElementById('messageBox').value };

        if (!token) {
          return console.log("Not logged in")
        }

        try {
          const response = await fetch(url, {
              method: 'POST',
              headers: {
                  'Content-Type': 'application/json',
                  'Authorization': 'Bearer ' + token,
              },
              body: JSON.stringify(dataToSend),
          });
          if (!response.ok) {
              throw new Error(`HTTP error! Status: ${response.status}`);
          }
          const data = response
        } catch (err) {
            console.error('Fetch error:', err);
        }
      }
      const socket = io();
      
      async function updateLed(command, device) {
        const url = `http://localhost:3000/api/${device}`;
        const dataToSend = { command: command };

        try {
            const response = await fetch(url, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'Authorization': 'Bearer ' + token,
                },
                body: JSON.stringify(dataToSend),
            });
            if (!response.ok) {
                throw new Error(`HTTP error! Status: ${response.status}`);
            }
            const data = response
        } catch (err) {
            console.error('Fetch error:', err);
        }
  }

      socket.on('data', (data) => {

        deviceStatusContainer.innerHTML = '';
        data.devices.forEach((device) => {
          const deviceStatusElement = document.createElement('p');
          deviceStatusElement.textContent = `${device.name}: Status - ${device.status}`;
          const offButton = document.createElement('button')
          offButton.innerHTML = `turn off ${device.name}`
          offButton.onclick = function() { updateLed('0', device.name)}
          const onButton = document.createElement('button')
          onButton.innerHTML = `turn on ${device.name}`
          onButton.onclick = function() { updateLed('1', device.name)}
          deviceStatusContainer.appendChild(deviceStatusElement);
          deviceStatusContainer.appendChild(onButton)
          deviceStatusContainer.appendChild(offButton)
       });
 
       data.sensors.forEach((device) => {
          const deviceStatusElement = document.createElement('p');
          deviceStatusElement.textContent = `${device.name}: Status - ${device.value}`;
          deviceStatusContainer.appendChild(deviceStatusElement);
       });
 
       
        const deviceStatusElement = document.createElement('p');
        const messages = data.lcd[0].messages.map(message => `<br>${message}`).join('');
        deviceStatusElement.innerHTML = `${data.lcd[0].name}: messages - ${messages}`;
        deviceStatusContainer.appendChild(deviceStatusElement);
      });
      
    </script>
  </body>
</html>